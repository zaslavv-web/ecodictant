<!DOCTYPE html>
<html lang="ru" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Экодиктант - Личный кабинет</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <img src="ecotalk_logo.png" alt="Экотолк Logo" class="logo">
    </div>
    <div id="greeting-popup" style="display: none;">
        <h2 id="greeting-title"></h2>
        <p id="greeting-message"></p>
        <p id="password-message"></p>
        <form id="confirm-form">
            <div class="form-group">
                <label for="confirm-password" id="confirm-password-label"></label>
                <input type="text" id="confirm-password" required>
            </div>
            <button type="button" class="submit-button" id="confirm-button" onclick="confirmEmail()"></button>
        </form>
    </div>
    <div class="dashboard-content" id="dashboard-content" style="display: none;">
        <h2 id="dashboard-title"></h2>
        <p id="welcome-user"></p>
        <!-- Role-specific content loaded dynamically -->
    </div>
    <script src="locals.js"></script>
    <script>
        const currentDate = new Date('2025-09-14');
        let user = JSON.parse(localStorage.getItem('user'));
        let primaryPassword = '';

        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function confirmEmail() {
            const enteredPassword = document.getElementById('confirm-password').value;
            if (enteredPassword === primaryPassword) {
                user.confirmed = true;
                localStorage.setItem('user', JSON.stringify(user));
                document.getElementById('greeting-popup').style.display = 'none';
                showDashboard();
            } else {
                alert(translations[user.lang].password_mismatch || 'Passwords do not match');
            }
        }

        function showDashboard() {
            document.getElementById('dashboard-content').style.display = 'block';
            const birthDate = new Date(user.birthdate);
            let age = currentDate.getFullYear() - birthDate.getFullYear();
            const m = currentDate.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && currentDate.getDate() < birthDate.getDate())) {
                age--;
            }
            const isMinor = age < 18;
            let pageUrl = '';
            if (user.role === 'participant') {
                pageUrl = isMinor ? 'young_participant.html' : 'adult_participant.html';
            } else if (user.role === 'volunteer') {
                pageUrl = isMinor ? 'young_volunteer.html' : 'adult_volunteer.html';
            } else if (user.role === 'curator') {
                pageUrl = 'curator_materials.html';
            }
            window.location.href = pageUrl + '?lang=' + user.lang;
        }

        window.onload = function() {
            if (user) {
                setLanguage(user.lang);
                if (!user.confirmed) {
                    primaryPassword = generatePassword();
                    // Simulate sending to email
                    console.log(`Primary password sent to ${user.email}: ${primaryPassword}`);
                    alert(`Primary password sent to your email: ${primaryPassword}`); // For demo
                    document.getElementById('greeting-popup').style.display = 'block';
                    document.getElementById('greeting-message').textContent = translations[user.lang].greeting + ' ' + user.name + '!';
                    document.getElementById('password-message').textContent = translations[user.lang].confirm_email;
                    document.getElementById('confirm-password-label').textContent = translations[user.lang].enter_password;
                    document.getElementById('confirm-button').textContent = translations[user.lang].confirm_button;
                } else {
                    showDashboard();
                }
            } else {
                // Redirect to registration if no user
                window.location.href = 'index.html';
            }
        };
    </script>
</body>
</html>